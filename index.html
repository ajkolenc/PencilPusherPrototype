<html>

	<head>
		<title>0</title>

		<!--Libraries-->
		<script src="jquery-2.1.0.js"></script>

		<script src="player.js"></script>

		<script src="ArlLib/ArlMath.js"></script>
		<script src="ArlLib/ArlPhysics.js"></script>
		<script src="ArlLib/ArlDraw.js"></script>
		<script src="ArlLib/ArlGame.js"></script>
		<script src="ArlLib/ArlEtc.js"></script>

		<script>
			//logic
			var money = 0;
			var moneyRate = 0;
			var moneyTimer = new ArlEtc.Timer(1);
			var menus = ["deskMenu", "officeMenu", "employeesMenu", "emailMenu"];
			var menuIndex = 0;
			var employeeLevelDepth = 0;

			//ajax server communication
			var username = "Test User 1";
			var gameInfo;
			var updateTimer = new ArlEtc.Timer(5);

			//text
			var moneyUnit = "moneyz";
			var quoteChar = '"';
			var quoteChar_Single = "'";
			var myName = "ME";
			var myBossName = "MY BOSS";

			//graphics
			var dullRed = new ArlDraw.Color(200,100,100,1);
			var dullBlue = new ArlDraw.Color(100,100,200,1);
			var dullGreen = new ArlDraw.Color(100,200,100,1);
			var darkGrey = new ArlDraw.Color(50,50,50,1);
			var employeeColor1 = new ArlDraw.Color(200,200,200,1);
			var employeeColor2 = new ArlDraw.Color(150,150,150,1);
			var emailUnread = new ArlDraw.Color(230,230,230,1);
			var emailRead = new ArlDraw.Color(120,120,120,1);
			var scribbleList = [];
			var maxScribbleLength = 800;

			//data
			var employeeList = [];
			var notificationList = [];

			//EVENTS
			ArlGame.events.resize = function() {
				//number of pixels inside the canvas should match the number of pixels it takes up on the screen
				ArlGame.gameCanvas.width = ArlGame.gameCanvas.scrollWidth;
				ArlGame.gameCanvas.height = ArlGame.gameCanvas.scrollHeight;
			};
			ArlGame.events.onCursorDown = function() {
				scribbleList.push(new ArlMath.Point(ArlGame.cursorPos.x, ArlGame.cursorPos.y));

				notificationList.push(new Message("test test test"));
			};
			ArlGame.events.onCursorMove = function() {
				if (ArlGame.isCursorDown) {
					scribbleList.push(new ArlMath.Point(ArlGame.cursorPos.x, ArlGame.cursorPos.y));

					if (ArlMath.pathLength(scribbleList) > maxScribbleLength) {
						money++;
						scribbleList = [];
					}
				}
			};
			ArlGame.events.onCursorUp = function() {
				scribbleList = [];
			};
			ArlGame.events.init = function() {
				//number of pixels inside the canvas should match the number of pixels it takes up on the screen
				ArlGame.gameCanvas.width = ArlGame.gameCanvas.scrollWidth;
				ArlGame.gameCanvas.height = ArlGame.gameCanvas.scrollHeight;

				//gameInfo = new GameInfo("Test User 1");
				switchUser("Test User 1");

				//var e = new Employee("Bob", 1000, null);
				//console.log(e.toHTML());
				//document.body.innerHTML += e.toHTML();
			};
			ArlGame.events.mainLoop = function() {
				ArlDraw.clearCanvas(ArlGame.gameCanvas);

				var realMoneyRate = moneyRate * 0.5;

				var curMoney = Math.floor(money + (realMoneyRate * moneyTimer.percentDone()));	
				document.getElementById("money").innerHTML = curMoney + " " + moneyUnit;
				document.title = curMoney;
				document.getElementById("moneyRate").innerHTML = moneyRate + " " + moneyUnit + " / second";

				if (moneyTimer.isDone()) {
					money += realMoneyRate;
					moneyTimer.reset();
				}

				if (updateTimer.isDone()) {
					$.ajax({
						url: 'http://www.ajkolenc.com/PencilPusher/gameLogic.php',
						type: 'post',
						data: {'UpdateType' : 'NormalUpdate', 'Username' : username},
						success: function(msg) {
							//console.log(msg); //returns xml whooo which can be parsed by player.js whoo
							gameInfo.update(msg);

							myBossName = gameInfo.boss.username;

							money = gameInfo.player.money;
							//console.log(gameInfo.player.money);
							moneyRate = parseInt(gameInfo.player.production)
						},
						error: function() {
							console.log("nope nope nope");
						}
					});
					updateTimer.reset();
				}

				drawPaperLines(ArlGame.context, ArlGame.gameCanvas.width, ArlGame.gameCanvas.height, 10, dullRed, dullBlue);
				ArlDraw.drawPath(ArlGame.context, scribbleList, 2, darkGrey);

				updateEmailButton();
			};

			//FUNCTIONS
			var drawPaperLines = function (context, width, height, numLines, color1, color2) {
				var lineSeparation = (height - (height/5)) / numLines;
				for (var i = 0; i < numLines; i++) {
					ArlDraw.drawLine(context, 0, (height/5) + (i*lineSeparation), width, (height/5) + (i*lineSeparation), 1, color2);
				}
				ArlDraw.drawLine(context, width/6, 0, width/6, height, 2, color1);
			}

			var buyUpgrade = function(cost, itemName) {
				if (money >= cost) {
					/*
					money -= cost;
					moneyRate += benefit;
					*/

					money -= cost;

					$.ajax({
						url: 'http://www.ajkolenc.com/PencilPusher/gameLogic.php',
						type: 'post',
						data: {'UpdateType' : 'BoughtItem', 'Username' : username, 'NewItem' : itemName},
						success: function(msg) {
							console.log(msg); //returns xml whooo which can be parsed by player.js whoo
							gameInfo.update(msg);

							money = gameInfo.player.money;
							//console.log(gameInfo.player.money);
							moneyRate = parseInt(gameInfo.player.production)
						},
						error: function() {
							console.log("nope nope nope");
						}
					});
				}
			}

			var getMenu = function(index) {
				return document.getElementById(menus[index]);
			}

			var switchMenu = function(index) {
				if (menuIndex == 3) {
					for (var i = 0; i < notificationList.length; i++) {
						notificationList[i].isRead = true;
					}
				}

				getMenu(menuIndex).style.display = "none";
				menuIndex = index;
				getMenu(menuIndex).style.display = "block";	

				if (menuIndex == 2) {
					var employeesDiv = document.getElementById("employeesMenu");
					employeesDiv.innerHTML = "";
					employeeLevelDepth = 0;

					/*
					newBossLevel(e1.name);
					newEmployeeLevel(1, e1.name);
					newEmployeeLevel(2, e2.name);
					*/
					newBossLevel(gameInfo.boss);
					myBossName = gameInfo.boss.username;
					newEmployeeLevel(1, gameInfo.boss.username);
					newEmployeeLevel(2, gameInfo.player.username);
				}
				else if (menuIndex == 3) {
					var notificationDiv = document.getElementById("emailMenu")
					notificationDiv.innerHTML = "";

					for (var i = notificationList.length-1; i >= 0; i--) {
						notificationDiv.innerHTML += notificationList[i].toHTML();
					}
				}
			}

			var switchUser = function(newUsername) {
				username = newUsername;
				gameInfo = new GameInfo(username);
				document.getElementById("usernameOutput").innerHTML = "USER: " + username;

				$.ajax({
					url: 'http://www.ajkolenc.com/PencilPusher/gameLogic.php',
					type: 'post',
					data: {'UpdateType' : 'NormalUpdate', 'Username' : username},
					success: function(msg) {
						//console.log(msg); //returns xml whooo which can be parsed by player.js whoo
						gameInfo.update(msg);

						money = gameInfo.player.money;
						//console.log(gameInfo.player.money);
						moneyRate = parseInt(gameInfo.player.production)
					},
					error: function() {
						console.log("nope nope nope");
					}
				});
			}

			var newEmployeeLevel = function(level, bossName, color) {
				console.log("***");
				console.log(employeeLevelDepth);

				$.ajax({
					url: 'http://www.ajkolenc.com/PencilPusher/gameLogic.php',
					type: 'post',
					data: {'UpdateType' : 'NormalUpdate', 'Username' : bossName},
					success: function(msg) {
						//console.log(msg); //returns xml whooo which can be parsed by player.js whoo
						var tempGameInfo = new GameInfo(bossName);
						tempGameInfo.update(msg);


						var levelDiv = document.getElementById("employeeLevel" + level.toString());
						if (levelDiv == null) {
							document.getElementById("employeesMenu").innerHTML += "<div id='employeeLevel" + level.toString() + "' class='employeeLevel'></div>";
							levelDiv = document.getElementById("employeeLevel" + level.toString());
						}


						if (level > employeeLevelDepth) {
							employeeLevelDepth = level;
						}

						console.log("clear");
						for (var i = level; i <= employeeLevelDepth; i++) {
							console.log(i);
							document.getElementById("employeeLevel" + i.toString()).innerHTML = "";
						}

						levelDiv.innerHTML = "";
						levelDiv.innerHTML += bossName + "'s EMPLOYEES <br/>"
						for (var i = 0; i < tempGameInfo.employees.length; i++) {
							var e = new Employee(tempGameInfo.employees[i].username, parseInt(tempGameInfo.employees[i].production));
							levelDiv.innerHTML += e.toHTML(level);
						}

						if (bossName == myBossName) {
							levelDiv.style.background = dullBlue.toHTML();
						}
						else {
							if (level % 2 == 0) {
								levelDiv.style.background = employeeColor1.toHTML();
							}
							else {
								levelDiv.style.background = employeeColor2.toHTML();
							}
						}
					},
					error: function() {
						console.log("nope nope nope");
					}
				});

				/*
				var levelDiv = document.getElementById("employeeLevel" + level.toString());
				if (levelDiv == null) {
					document.getElementById("employeesMenu").innerHTML += "<div id='employeeLevel" + level.toString() + "' class='employeeLevel'></div>";
					levelDiv = document.getElementById("employeeLevel" + level.toString());
				}


				if (level > employeeLevelDepth) {
					employeeLevelDepth = level;
				}

				console.log("clear");
				for (var i = level; i <= employeeLevelDepth; i++) {
					console.log(i);
					document.getElementById("employeeLevel" + i.toString()).innerHTML = "";
				}

				var boss = findEmployeeByName(bossName);

				levelDiv.innerHTML = "";
				levelDiv.innerHTML += bossName + "'s EMPLOYEES <br/>"
				for (var i = 0; i < boss.employees.length; i++) {
					var e = boss.employees[i];
					levelDiv.innerHTML += e.toHTML(level);
				}

				if (bossName == myBossName) {
					levelDiv.style.background = dullBlue.toHTML();
				}
				else {
					if (level % 2 == 0) {
						levelDiv.style.background = employeeColor1.toHTML();
					}
					else {
						levelDiv.style.background = employeeColor2.toHTML();
					}
				}
				*/
			}

			/*
			var newBossLevel = function(bossName, color) {
				var level = 0;
				var levelDiv = document.getElementById("employeeLevel" + level.toString());
				if (levelDiv == null) {
					document.getElementById("employeesMenu").innerHTML += "<div id='employeeLevel" + (level).toString() + "' class='employeeLevel'></div>";
					levelDiv = document.getElementById("employeeLevel" + level.toString());
				}

				var boss = findEmployeeByName(bossName);

				levelDiv.innerHTML = "";
				levelDiv.innerHTML += "BOSS <br/>"
				levelDiv.innerHTML += boss.toHTML(level);
				levelDiv.style.background = dullRed.toHTML();
			}
			*/

			var newBossLevel = function(bossInfo, color) {
				var level = 0;
				var levelDiv = document.getElementById("employeeLevel" + level.toString());
				if (levelDiv == null) {
					document.getElementById("employeesMenu").innerHTML += "<div id='employeeLevel" + (level).toString() + "' class='employeeLevel'></div>";
					levelDiv = document.getElementById("employeeLevel" + level.toString());
				}

				var boss = new Employee(bossInfo.username, bossInfo.production);

				levelDiv.innerHTML = "";
				levelDiv.innerHTML += "BOSS <br/>"
				levelDiv.innerHTML += boss.toHTML(level);
				levelDiv.style.background = dullRed.toHTML();
			}

			var findEmployeeByName = function(name) {
				for (var i = 0; i < employeeList.length; i++) {
					var e = employeeList[i];
					if (e.name == name) {
						return e;
					}
				}
				return null;
			}

			var updateEmailButton = function() {
				var unread = 0;
				for (var i = 0; i < notificationList.length; i++) {
					if (!notificationList[i].isRead) {
						unread++;
					}
				}
				document.getElementById("emailButton").innerHTML = "Email Inbox (" + unread.toString() + ")";
			}

			//OBJECTS
			var Employee = function(name, productionRate, boss) {
				this.name = name;
				this.productionRate = productionRate;
				this.boss = boss;
				if (boss != null) {
					this.boss.addEmployee(this);
				}
				this.employees = [];
			};
			Employee.prototype = {
				addEmployee: function(newEmployee) {
					this.employees.push(newEmployee);
				},
				toHTML: function(level) {
					var htmlStr = "";

					htmlStr += "<div class='employeeBoxWrapper' style='color: #000; position: relative; float:left;'>";
					htmlStr += "<center>";
					htmlStr += "^<br/>";
					htmlStr += "|<br/>";
					htmlStr += "<div class='employeeBox' onclick='newEmployeeLevel(" + (level + 1).toString() + "," + quoteChar + this.name + quoteChar + ", employeeColor1);'>";
					htmlStr += this.name + "<br/>";
					htmlStr += this.productionRate + " " + moneyUnit + " / second <br/>";
					htmlStr += "</div>";
					htmlStr += "</center>";
					htmlStr += "</div>";

					return htmlStr;
				},
			};

			var Message = function(message) {
				this.message = message;
				this.isRead = false;
			};
			Message.prototype = {
				toHTML: function(color) {
					var htmlStr = "";

					var fontWeight = "normal";
					var c = emailRead.toHTML();
					if (!this.isRead) {
						fontWeight = "bold";
						c = emailUnread.toHTML();
					}

					htmlStr += "<div class='notification' style='background: " + c + "; font-weight: " + fontWeight + ";'>";
					htmlStr += this.message;
					htmlStr += "</div>";

					return htmlStr;
				},
			};

			//test
			var e1 = new Employee("MY BOSS", 10000, null);
			var e2 = new Employee("ME", 4500, e1);
			var e3 = new Employee("Bob", 100, e2);
			var e4 = new Employee("Sally", 10, e2);
			var e5 = new Employee("Lucy", 55, e2);
			var e6 = new Employee("Sarah", 10, e3);
			var e7 = new Employee("Leon", 55, e4);
			var e8 = new Employee("Jimmy", 10, e4);
			var e9 = new Employee("Judy", 55, e5);
			var e10 = new Employee("Joyce", 10, e5);
			var e11 = new Employee("Leon2", 55, e10);
			var e12 = new Employee("Jimmy2", 10, e10);
			var e13 = new Employee("Judy2", 55, e10);
			var e14 = new Employee("Joyce2", 10, e10);
			employeeList = [e1, e2, e3, e4, e5, e6, e7, e8, e9, e10, e11, e12, e13, e14];

			var n1 = new Message("test 1");
			var n2 = new Message("hello world");
			var n3 = new Message("the blah blah blah jumps over the blah lazy blah");
			notificationList = [n1, n2, n3];
		</script>

		<style>
			body {
				background: #444;
				color: #aaa;
				font-family: monospace;
			}
			#money {
				font-size: 80px;
			}
			#moneyRate {
				font-size: 30px;
			}
			#menuBar {
				background: #aaa;
			}
			button {
				color: #333;
				background: #ccc;
				border: 1px solid #333;
				font-family: monospace;
				font-size: 15px;
			}
			button:hover {
				color: #ccc;
				background: #333;
			}
			.menuButton {
			}
			.menuButton:hover {
			}
			#ArlGameCanvas {
				background: #eee;
				height: 80%;
				width: 20%;
				float: left;
			}
			#shop {
				float: right;
				width: 30%;
				font-size: 30px;
			}
			.employeeBoxWrapper {
				width: 150px;
				margin-left: 10px;
			}
			.employeeBox {
				background: #aaa;
				color: #333;
				border: 2px solid #333;
				height: 50px;
			}
			#mainContent {
				height: 60%;
				margin: 2%;
			}
			.employeeLevel {
				height: 30%;
				color: #333;
				overflow: scroll;
				overflow-y: none;
			}
			.notification {
				color: #333;
				border: 1px solid #666;
			}
			#accountInfo {
				float: right;
			}
		</style>
	</head>

	<body onload="ArlGame.init()" onresize="ArlGame.resize()">
		PENCIL PUSHER
		<div id = "accountInfo">
			<div id="usernameOutput">
				USER: USERNAME
			</div>
			<input id="usernameInput" type="text" placeholder="User Name"></input>
			<button onclick="switchUser(document.getElementById('usernameInput').value);"> LOGIN </button>
		</div>
		<center>
		<div id="money">
			0 moneyz
		</div>
		<div id="moneyRate">
			0 moneyz / second
		</div>
		<div id="menuBar">
			<button class="menuButton" id="deskButton" onclick="switchMenu(0);">My Desk</button>
			<button class="menuButton" id="officeButton" onclick="switchMenu(1);">My Office</button>
			<button class="menuButton" id="employeesButton" onclick="switchMenu(2);">Organizational Chart</button>
			<button class="menuButton" id="emailButton" onclick="switchMenu(3);">Email Inbox (0)</button>
		</div>
		</center>


		<div id="mainContent">
			<div id="deskMenu">
				<canvas id="ArlGameCanvas">
				</canvas>
				<div id="shop">
					OFFICE SUPPLIES
					<br/>
					<button onclick="buyUpgrade(5,'Pen');">Buy Pen (5$)</button>
					<button onclick="buyUpgrade(100,'Typewriter');">Buy Typewriter (100$)</button>
					<button onclick="buyUpgrade(1500,'Word Processor');">Buy Word Processor (1500$)</button>
				</div>
			</div>
			<div id="officeMenu" style="display:none;">
			</div>
			<div id="employeesMenu" style="display:none;">
			</div>
			<div id="emailMenu" style="display:none;">
			</div>
		</div>
	</body>

</html>